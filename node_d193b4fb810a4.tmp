const Discord = require('discord.js');
const client = new Discord.Client();
const filename = './config.json'
const ytdl = require('ytdl-core');
const fs = require('fs');
const ytSearch = require('yt-search');
var file_content = fs.readFileSync(filename);
var content = JSON.parse(file_content);
var dispatcher;
var queue = new Array;
var queueTitle = new Array;
var p=false;
var queueEmbed = new Discord.RichEmbed();
var desc;

client.on('ready', () => {
	console.log(`Logged in as ${client.user.tag}!`);
});

client.on('message', async msg => {
	if (!msg.content.startsWith(content.prefix)) return;
	var args = msg.content.slice(content.prefix.length).trim().split(/ +/g);
	const command = args.shift().toLowerCase();
	const member = msg.mentions.members.first();

	if (command === "obudź") {
		console.log(args[1]);
		if(!member.voiceChannelID){
			msg.reply("Użytkownik nie znajduje sie na kanale głosowym");
			return;
		}else if(args[1] > content.moveLimit){
			msg.reply("Limit budzenia to: " + content.moveLimit);
			return;
		}
		for(var i = 0; i < args[1]; i++){
				member.setVoiceChannel('520690188561940490');
			member.setVoiceChannel('481903742392729604');
		}
	}

	if (command === "usuń"){
		msg.channel.bulkDelete(++args[0]).then(() => {
			msg.channel.send("Usunięte " + --args[0] + " wiadomości").then(message => message.delete(3000));
		});
	}

	if (command === "limit"){
		if(args[0] == undefined){
			msg.reply("Altualny limit budzenia to: " + content.moveLimit);
		}else if (msg.member.roles.some(r => "BotMod".includes(r.name))){
			content.moveLimit = args[0];
			fs.writeFileSync(filename, JSON.stringify(content));
			msg.reply("Limit budzenia został zmieniny, aktualny limit to: " + content.moveLimit);
		}else{
			msg.reply("Nie masz wystarczających uprawnień aby zmieniać limit budzenia");
		}
	}

	if (command === "summon" || command === "join"){
		if (msg.member.voiceChannel){
			if (!msg.guild.voiceConnection){
				//
				msg.member.voiceChannel.join();
				p=true;
			}else{
				if (msg.member.voiceChannel.name === msg.guild.voiceConnection.channel.name){
					msg.reply("Jestem tutaj!");
				}else{
					msg.reply("Jestem zajęty!");
				}
			}
		}else{
			msg.reply("Musisz dołaczyć do kanału głosowego żeby to zrobić");
		}
	}

	if (command === "dc" || command === "disconnect" || command === "leave"){
		if (msg.member.voiceChannel){
			if (msg.guild.voiceConnection){
				if(msg.member.voiceChannel.name === msg.guild.voiceConnection.channel.name){
					//
					p=false;
					msg.guild.voiceConnection.disconnect();
					queue = [];
				}else{
					msg.reply("Musisz być na tym samym kanale głoswym co ja zeby to zrobić");
				}
			}else{
				msg.reply("Nie jestem na żadnym kanale głosowym");
			}
		}else{
			msg.reply("Musisz dołaczyć do kanału głosowego żeby to zrobić");
		}
	}

	if (command === "play" || command === "p"){
		if (msg.member.voiceChannel){
			if (!msg.guild.voiceConnection){
				msg.member.voiceChannel.join();
				p=true;
				//
			}else{
				if (msg.member.voiceChannel.name === msg.guild.voiceConnection.channel.name){
					//
				}else{
					msg.reply("Musisz być na tym samym kanale głoswym co ja zeby to zrobić");
					return;
				}
			}
		}else{
			msg.reply("Musisz dołaczyć do kanału głosowego żeby to zrobić");
			return;
		}

		const name = args.toString().replace(/,/g,' ');
		var url;
		var title;
		ytSearch(name, function ( err, r ) {
			if (err) throw err;
			const videos = r.videos;
			url = ('https://www.youtube.com' + videos[0].url);
			title = videos[0].title;

			if(!dispatcher || dispatcher.destroyed ||  dispatcher.paused){
				dispatcher = msg.guild.voiceConnection.playStream(ytdl(url, {filter: 'audioonly'} )).on('end', () => {
					if(!dispatcher.paused && p){
						dispatcher = msg.guild.voiceConnection.playStream(ytdl(queue[0], {filter: 'audioonly'} ));
						msg.channel.send("Odtwarzam - **" + queueTitle[0] + "**");
                        queue.shift();
                        queueTitle.shift();
					};
				});
			}else{
                queue.push(url);
                queueTitle.push(title);
				msg.channel.send("Dodałem do kolejki - **" + queueTitle[queueTitle.length-1] + "**");
				return;
			}
			dispatcher.setVolume(content.volume);
			msg.channel.send("Odtwarzam - **" + title + "**");
		});

	}

	if (command === "pause" || command === "stop"){
		if (msg.member.voiceChannel){
			if (msg.guild.voiceConnection){
				if(msg.member.voiceChannel.name === msg.guild.voiceConnection.channel.name){
					//
				}else{
					msg.reply("Musisz być na tym samym kanale głoswym co ja zeby to zrobić");
					return;
				}
			}else{
				msg.reply("Nie jestem na żadnym kanale głosowym");
				return;
			}
		}else{
			msg.reply("Musisz dołaczyć do kanału głosowego żeby to zrobić");
			return;
		}

		if(dispatcher && !dispatcher.paused && !dispatcher.destroyed){
			dispatcher.pause();
		}else{
			msg.reply("Nic nie leci :(");
		}
	}

	if (command === "wznów" || command === "resume"){
		if (msg.member.voiceChannel){
			if (msg.guild.voiceConnection){
				if(msg.member.voiceChannel.name === msg.guild.voiceConnection.channel.name){
					//
				}else{
					msg.reply("Musisz być na tym samym kanale głoswym co ja zeby to zrobić");
					return;
				}
			}else{
				msg.reply("Nie jestem na żadnym kanale głosowym");
				return;
			}
		}else{
			msg.reply("Musisz dołaczyć do kanału głosowego żeby to zrobić");
			return;
		}

		if(dispatcher && dispatcher.paused && !dispatcher.destroyed){
			dispatcher.resume();
		}else{
			msg.reply("Nic nie leci :(");
		}
	}

	if(command === "vol" || command === "volume" || command === "głośność"){
		if (msg.member.voiceChannel){
			if (msg.guild.voiceConnection){
				if(msg.member.voiceChannel.name === msg.guild.voiceConnection.channel.name){
					//
				}else{
					msg.reply("Musisz być na tym samym kanale głoswym co ja zeby to zrobić");
					return;
				}
			}else{
				msg.reply("Nie jestem na żadnym kanale głosowym");
				return;
			}
		}else{
			msg.reply("Musisz dołaczyć do kanału głosowego żeby to zrobić");
			return;
		}

		if(args[0] == undefined){
			msg.reply("Altualna głośność to: " + content.volume*100);
			return;
		}
		if(dispatcher && !dispatcher.paused && !dispatcher.destroyed){
			dispatcher.setVolume(args[0]/100);
			content.volume = args[0]/100;
			fs.writeFileSync(filename, JSON.stringify(content));
			msg.reply("Głośność została zmieniona na: " + content.volume*100);
		}else{
			msg.reply("Nic nie leci :(");
		}
	}

	if(command === "q"){
		if (msg.member.voiceChannel){
			if (msg.guild.voiceConnection){
				if(msg.member.voiceChannel.name === msg.guild.voiceConnection.channel.name){
					//
				}else{
					msg.reply("Musisz być na tym samym kanale głoswym co ja zeby to zrobić");
					return;
				}
			}else{
				msg.reply("Nie jestem na żadnym kanale głosowym");
				return;
			}
		}else{
			msg.reply("Musisz dołaczyć do kanału głosowego żeby to zrobić");
			return;
        }
		msg.channel.sendEmbed(queue.toString().replace(/,/g,'\t'));
    }
    
    if(command === "test"){
        for(var i = 0; i < queue.length; i++){
            desc = desc + "[" + queueTitle[i] + "]" + "(" + queue[i] + ")\n";
            console.log(desc);
        }
        queueEmbed
            .setColor(3447003)
            .setTitle("Kolejka:")
            .setDescription(desc);
        msg.channel.send(queueEmbed);
    }

});



client.login(content.token);